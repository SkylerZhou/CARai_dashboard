<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CARai Dashboard</title> 

  <!-- Load Tailwind CSS for styling (buttons, colors, spacing, etc) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Custom CSS for professional scientific styling -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      letter-spacing: -0.011em;
      background: #f5f7fa;
    }

    :root {
      --primary-blue: #1e4976;
      --secondary-blue: #2e5f8a;
      --accent-blue: #4a90e2;
      --light-blue: #e8f2f7;
      --border-gray: #d1dbe6;
      --text-primary: #2c3e50;
      --text-secondary: #5a6c7d;
      --bg-panel: #ffffff;
    }
  </style>

  <!-- Load React and ReactDOM from CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Load Babel to compile JSX in browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <!-- Root element where React will render / Set a empty frame, everything will be drawn inside this frame. -->
  <div id="root"></div>

  <!-- React Component Code -->
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Icon components: Upload, BarPlot, BoxPlot -----------------------------
    // Upload Icon: an arrow pointing up
    const Upload = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
      </svg>
    );
    
    // Bar Chart Icon: three vertical bars of different heights
    const BarChart3 = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M3 3v18h18"></path>
        <path d="M18 17V9"></path>
        <path d="M13 17V5"></path>
        <path d="M8 17v-3"></path>
      </svg>
    );

    // Box Icon: a 3D box shape
    const BoxIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
        <line x1="12" y1="22.08" x2="12" y2="12"></line>
      </svg>
    );

    // Check Icon Component --------------------------------------------------
    const CheckCircle = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
    );

    // Arrow Icon Component --------------------------------------------------
    const ArrowRight = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#5a6c7d" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="5" y1="12" x2="19" y2="12"></line>
        <polyline points="12 5 19 12 12 19"></polyline>
      </svg>
    );

    // Run Model Panel Component --------------------------------------------------
    const RunModelPanel = () => {
      const [logMessages, setLogMessages] = useState([]);
      const [showComplete, setShowComplete] = useState(false);

      const allMessages = [
        '[INFO] Loading data...',
        '[INFO] Preprocessing dataset...',
        '[INFO] Initializing CARai model...',
        '[INFO] Running inference...',
        '[INFO] Generating predictions...'
      ];

      const handleDataUpload = () => {
        setLogMessages([]);
        setShowComplete(false);

        // Show each log message one by one with 2 second interval
        allMessages.forEach((message, index) => {
          setTimeout(() => {
            setLogMessages(prev => [...prev, message]);
          }, (index + 1) * 2000);
        });

        // Show completion after all messages (10 seconds)
        setTimeout(() => {
          setShowComplete(true);
        }, (allMessages.length + 1) * 2000);
      };

      return (
        <div className="flex items-center justify-center gap-6">
          {/* Data Upload Button */}
          <button
            onClick={handleDataUpload}
            className="flex items-center gap-2 px-4 py-2 text-white rounded-sm transition"
            style={{
              background: '#4a90e2',
              fontSize: '14px',
              fontWeight: '500'
            }}
            onMouseOver={(e) => e.target.style.background = '#3d7bb8'}
            onMouseOut={(e) => e.target.style.background = '#4a90e2'}
          >
            <Upload />
            Data Upload
          </button>

          {/* First Arrow */}
          {logMessages.length > 0 && (
            <div className="flex items-center gap-4">
              <ArrowRight />

              {/* Log Display */}
              <div className="bg-gray-50 border rounded-sm p-4" style={{
                border: '1px solid #d1dbe6',
                minWidth: '300px',
                maxWidth: '400px'
              }}>
                <div style={{
                  fontFamily: 'monospace',
                  fontSize: '12px',
                  color: '#2c3e50',
                  whiteSpace: 'pre-wrap'
                }}>
                  {logMessages.join('\n')}
                </div>
              </div>
            </div>
          )}

          {/* Second Arrow and Completion Icon */}
          {showComplete && (
            <div className="flex items-center gap-4">
              <ArrowRight />

              {/* Completion Button/Icon */}
              <button
                className="flex items-center gap-2 px-4 py-2 text-white rounded-sm"
                style={{
                  background: '#4a90e2',
                  fontSize: '14px',
                  fontWeight: '500',
                  cursor: 'default'
                }}
              >
                <CheckCircle />
                Model Finished Running
              </button>
            </div>
          )}
        </div>
      );
    };

    // Scatter Plot Component --------------------------------------------------
    const ScatterPlot = ({ data }) => {
      const canvasRef = useRef(null);
      const [hoveredPoint, setHoveredPoint] = useState(null);
      const [mousePos, setMousePos] = useState({ x: 0, y: 0 });

      // Draws on a canvas 
      useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas || data.length === 0) return;

        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;

        // Clear canvas
        ctx.clearRect(0, 0, width, height);

        // Calculate bounds
        const xValues = data.map(d => d.x);
        const yValues = data.map(d => d.y);
        const xMin = Math.min(...xValues);
        const xMax = Math.max(...xValues);
        const yMin = Math.min(...yValues);
        const yMax = Math.max(...yValues);

        const padding = 60;
        const plotWidth = width - 2 * padding;
        const plotHeight = height - 2 * padding;

        // Draw axes
        ctx.strokeStyle = '#a8b8c8';
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.moveTo(padding, padding);
        ctx.lineTo(padding, height - padding);
        ctx.lineTo(width - padding, height - padding);
        ctx.stroke();

        // Draw grid
        ctx.strokeStyle = '#e8eef3';
        ctx.setLineDash([3, 3]);
        for (let i = 0; i <= 5; i++) {
          const y = padding + (plotHeight / 5) * i;
          ctx.beginPath();
          ctx.moveTo(padding, y);
          ctx.lineTo(width - padding, y);
          ctx.stroke();

          const x = padding + (plotWidth / 5) * i;
          ctx.beginPath();
          ctx.moveTo(x, padding);
          ctx.lineTo(x, height - padding);
          ctx.stroke();
        }
        ctx.setLineDash([]);

        // Draw axis labels
        ctx.fillStyle = '#5a6c7d';
        ctx.font = '11px Inter, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('UMAP 1', width / 2, height - 20);
        ctx.save();
        ctx.translate(20, height / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.fillText('UMAP 2', 0, 0);
        ctx.restore();

        // Scale functions
        const scaleX = (x) => padding + ((x - xMin) / (xMax - xMin)) * plotWidth;
        const scaleY = (y) => height - padding - ((y - yMin) / (yMax - yMin)) * plotHeight;

        // Draw points
        data.forEach(point => {
          const x = scaleX(point.x);
          const y = scaleY(point.y);

          ctx.fillStyle = point.color + 'AA';
          ctx.beginPath();
          ctx.arc(x, y, 4, 0, 2 * Math.PI);
          ctx.fill();
        });

        // Draw legend - using scientific color palette
        const labels = ['T-cell', 'B-cell', 'NK-cell', 'Monocyte', 'Dendritic'];
        const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd'];
        labels.forEach((label, idx) => {
          const legendX = width - 150;
          const legendY = padding + idx * 25;

          ctx.fillStyle = colors[idx];
          ctx.beginPath();
          ctx.arc(legendX, legendY, 5, 0, 2 * Math.PI);
          ctx.fill();

          ctx.fillStyle = '#2c3e50';
          ctx.font = '11px Inter, sans-serif';
          ctx.textAlign = 'left';
          ctx.fillText(label, legendX + 15, legendY + 4);
        });

      }, [data]);

      // When hover mouse over a point, show the nearest point
      // Shows a tooltip with point details
      const handleMouseMove = (e) => {
        const canvas = canvasRef.current;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        setMousePos({ x: e.clientX, y: e.clientY });

        // Find nearest point
        const xValues = data.map(d => d.x);
        const yValues = data.map(d => d.y);
        const xMin = Math.min(...xValues);
        const xMax = Math.max(...xValues);
        const yMin = Math.min(...yValues);
        const yMax = Math.max(...yValues);

        const padding = 60;
        const width = canvas.width;
        const height = canvas.height;
        const plotWidth = width - 2 * padding;
        const plotHeight = height - 2 * padding;

        const scaleX = (val) => padding + ((val - xMin) / (xMax - xMin)) * plotWidth;
        const scaleY = (val) => height - padding - ((val - yMin) / (yMax - yMin)) * plotHeight;

        let nearestPoint = null;
        let minDist = 20;

        data.forEach(point => {
          const px = scaleX(point.x);
          const py = scaleY(point.y);
          const dist = Math.sqrt((x - px) ** 2 + (y - py) ** 2);
          if (dist < minDist) {
            minDist = dist;
            nearestPoint = point;
          }
        });

        setHoveredPoint(nearestPoint);
      };

      // Display the canvas 
      return (
        <div className="relative">
          <canvas
            ref={canvasRef}
            width={900}
            height={500}
            onMouseMove={handleMouseMove}
            onMouseLeave={() => setHoveredPoint(null)}
            className="border border-gray-300 rounded-sm"
            style={{ borderColor: '#d1dbe6' }}
          />
          {hoveredPoint && (
            <div
              className="absolute bg-white p-2.5 border rounded-sm shadow-md text-xs pointer-events-none"
              style={{
                left: mousePos.x + 10,
                top: mousePos.y - 60,
                borderColor: '#d1dbe6',
                fontSize: '11px'
              }}
            >
              <p className="font-semibold" style={{ color: '#2c3e50' }}>{hoveredPoint.label}</p>
              <p style={{ color: '#5a6c7d' }}>UMAP1: {hoveredPoint.x.toFixed(3)}</p>
              <p style={{ color: '#5a6c7d' }}>UMAP2: {hoveredPoint.y.toFixed(3)}</p>
              <p className="text-xs" style={{ color: '#8895a5', fontSize: '10px' }}>{hoveredPoint.cellId}</p>
            </div>
          )}
        </div>
      );
    };

    // Bar Chart Component --------------------------------------------------
    const BarChartComponent = ({ data, modelColors }) => {
      const [animationProgress, setAnimationProgress] = useState(0);

      useEffect(() => {
        setAnimationProgress(0);
        const duration = 1500; // 1.5 seconds animation
        const steps = 60;
        const stepDuration = duration / steps;
        let currentStep = 0;

        const timer = setInterval(() => {
          currentStep++;
          setAnimationProgress(Math.min(currentStep / steps, 1));
          if (currentStep >= steps) {
            clearInterval(timer);
          }
        }, stepDuration);

        return () => clearInterval(timer);
      }, [data]);

      // Easing function for smooth animation
      const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);
      const animatedHeight = easeOutCubic(animationProgress);

      return (
        <svg width="1200" height="550" className="mx-auto">
          <g transform="translate(80, 40)">
            {/* Legend - moved to top left */}
            <rect x="10" y="-30" width="14" height="14" fill="#4a90e2" rx="1" />
            <text x="30" y="-20" fontSize="11" fill="#5a6c7d" fontFamily="Inter, sans-serif">Accuracy</text>
            <rect x="100" y="-30" width="14" height="14" fill="#4a90e2" fillOpacity="0.5" rx="1" />
            <text x="120" y="-20" fontSize="11" fill="#5a6c7d" fontFamily="Inter, sans-serif">F1 Score</text>

            {/* Y-axis */}
            <line x1="0" y1="0" x2="0" y2="400" stroke="#a8b8c8" strokeWidth="1.5" />
            <line x1="0" y1="400" x2="1000" y2="400" stroke="#a8b8c8" strokeWidth="1.5" />

            {/* Y-axis labels */}
            {[0, 0.2, 0.4, 0.6, 0.8, 1.0].map((val, idx) => (
              <g key={idx}>
                <line x1="-5" y1={400 - val * 400} x2="0" y2={400 - val * 400} stroke="#8895a5" />
                <text x="-10" y={400 - val * 400 + 4} textAnchor="end" fontSize="11" fill="#5a6c7d" fontFamily="Inter, sans-serif">
                  {val.toFixed(1)}
                </text>
              </g>
            ))}

            {/* Grid lines: faint horizontal lines*/}
            {[0, 0.2, 0.4, 0.6, 0.8, 1.0].map((val, idx) => (
              <line key={idx} x1="0" y1={400 - val * 400} x2="1000" y2={400 - val * 400}
                    stroke="#e8eef3" strokeDasharray="3,3" />
            ))}

            {/* Bars: display two bars (accuracy and F1) side-by-side for each model */}
            {data.map((item, idx) => {
              const barWidth = 60;
              const groupWidth = 1000 / data.length;
              const centerX = idx * groupWidth + groupWidth / 2;
              const x = centerX - barWidth / 2;

              const animatedAccuracyHeight = item.accuracy * 400 * animatedHeight;
              const animatedF1Height = item.f1Score * 400 * animatedHeight;

              return (
                <g key={idx}>
                  {/* Accuracy bar */}
                  <rect
                    x={x}
                    y={400 - animatedAccuracyHeight}
                    width={barWidth / 2 - 5}
                    height={animatedAccuracyHeight}
                    fill={modelColors[item.model]}
                    rx="4"
                  />

                  {/* F1 Score bar */}
                  <rect
                    x={x + barWidth / 2}
                    y={400 - animatedF1Height}
                    width={barWidth / 2 - 5}
                    height={animatedF1Height}
                    fill={modelColors[item.model]}
                    fillOpacity="0.6"
                    rx="4"
                  />

                  {/* Model label - rotated and centered */}
                  <text
                    x={centerX}
                    y="420"
                    textAnchor="end"
                    fontSize="11"
                    fill={item.model === 'CARai (our method)' ? '#d62728' : '#5a6c7d'}
                    fontFamily="Inter, sans-serif"
                    transform={`rotate(-45, ${centerX}, 420)`}
                  >
                    {item.model}
                  </text>
                </g>
              );
            })}

            {/* Axis labels */}
            <text x="500" y="490" textAnchor="middle" fontSize="12" fill="#5a6c7d" fontFamily="Inter, sans-serif">Model</text>
            <text x="-40" y="200" textAnchor="middle" fontSize="12" fill="#5a6c7d" fontFamily="Inter, sans-serif" transform="rotate(-90, -40, 200)">
              Score
            </text>
          </g>
        </svg>
      );
    };

    // File Upload Component --------------------------------------------------
    const FileUpload = ({ onDataLoaded }) => {
      const [isDragging, setIsDragging] = useState(false);
      const [status, setStatus] = useState('');
      const fileInputRef = useRef(null);

      const handleDragOver = (e) => {
        e.preventDefault();
        setIsDragging(true);
      };

      const handleDragLeave = (e) => {
        e.preventDefault();
        setIsDragging(false);
      };

      const handleDrop = (e) => {
        e.preventDefault();
        setIsDragging(false);
        const file = e.dataTransfer.files[0];
        if (file) loadFile(file);
      };

      const handleFileSelect = (e) => {
        const file = e.target.files[0];
        if (file) loadFile(file);
      };

      const loadFile = (file) => {
        const fileName = file.name.toLowerCase();
        setStatus(`Loading ${file.name}...`);

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            let rawData = null;

            if (fileName.endsWith('.json')) {
              rawData = JSON.parse(e.target.result);
            } else {
              // CSV or TSV
              const text = e.target.result;
              const delimiter = fileName.endsWith('.tsv') ? '\t' : ',';
              rawData = parseDelimitedFile(text, delimiter);
            }

            const normalizedData = normalizeUMAPData(rawData);
            onDataLoaded(normalizedData);
            setStatus(`Loaded ${normalizedData.length} cells successfully!`);
            setTimeout(() => setStatus(''), 3000);
          } catch (error) {
            setStatus(`Error: ${error.message}`);
          }
        };

        reader.readAsText(file);
      };

      const parseDelimitedFile = (text, delimiter) => {
        const lines = text.split('\n').filter(line => line.trim());
        if (lines.length === 0) return [];

        const headers = lines[0].split(delimiter).map(h => h.trim().replace(/^["']|["']$/g, ''));
        const data = [];

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          const values = line.split(delimiter);
          const row = {};

          headers.forEach((header, idx) => {
            if (!header) return;

            let value = values[idx]?.trim().replace(/^["']|["']$/g, '') || '';

            // Try to parse as number
            if (value && !isNaN(value)) {
              row[header] = parseFloat(value);
            } else {
              row[header] = value;
            }
          });

          data.push(row);
        }

        return data;
      };

      const normalizeUMAPData = (data) => {
        if (!Array.isArray(data) || data.length === 0)
          throw new Error('No valid data found');

        const firstRow = data[0];
        const allKeys = Object.keys(firstRow);

        console.log('Available columns:', allKeys);
        console.log('Sample row:', firstRow);

        // Find UMAP columns
        const xCol = ['umapharmony_1', 'UMAP_1', 'umap_1', 'UMAP1', 'umap1', 'x', 'X'].find(name => allKeys.includes(name)) ||
                     allKeys.find(key => key.toLowerCase().includes('umap') && (key.includes('1') || key.toLowerCase().endsWith('1')));
        const yCol = ['umapharmony_2', 'UMAP_2', 'umap_2', 'UMAP2', 'umap2', 'y', 'Y'].find(name => allKeys.includes(name)) ||
                     allKeys.find(key => key.toLowerCase().includes('umap') && (key.includes('2') || key.toLowerCase().endsWith('2')));

        console.log('Found X column:', xCol);
        console.log('Found Y column:', yCol);

        if (!xCol || !yCol)
          throw new Error(`Could not find UMAP coordinates. Available columns: ${allKeys.join(', ')}`);

        // Find ID column - look for cell_ids, cell_id, id, barcode, etc.
        const idCol = allKeys.find(key =>
          key.toLowerCase() === 'cell_ids' ||
          key.toLowerCase() === 'cell_id' ||
          key.toLowerCase() === 'id' ||
          key.toLowerCase() === 'barcode' ||
          key.toLowerCase().includes('cell') && key.toLowerCase().includes('id')
        ) || allKeys[0]; // Default to first column

        console.log('Found ID column:', idCol);

        // Find categorical columns for coloring
        const categories = {};
        allKeys.forEach(key => {
          if (key !== xCol && key !== yCol && key !== idCol) {
            const uniqueValues = new Set(data.map(d => d[key]));
            if (uniqueValues.size < 50 && uniqueValues.size > 1 && typeof firstRow[key] === 'string') {
              categories[key] = Array.from(uniqueValues);
            }
          }
        });

        console.log('Found categories:', categories);

        const normalized = data
          .map((row, i) => ({
            x: parseFloat(row[xCol]),
            y: parseFloat(row[yCol]),
            cellId: row[idCol] || `cell_${i}`,
            label: row[idCol] || `cell_${i}`,
            ...Object.fromEntries(
              Object.entries(row).filter(([k]) => k !== xCol && k !== yCol && k !== idCol)
            )
          }))
          .filter(d => !isNaN(d.x) && !isNaN(d.y) && isFinite(d.x) && isFinite(d.y));

        console.log(`Normalized ${normalized.length} points`);

        normalized.categories = categories;
        return normalized;
      };

      return (
        <div style={{ marginBottom: '20px' }}>
          <div
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            onDrop={handleDrop}
            style={{
              border: `2px dashed ${isDragging ? '#4a90e2' : '#d1dbe6'}`,
              borderRadius: '8px',
              padding: '30px',
              textAlign: 'center',
              background: isDragging ? '#f0f7ff' : '#fafafa',
              cursor: 'pointer',
              transition: 'all 0.3s'
            }}
            onClick={() => fileInputRef.current?.click()}
          >
            <input
              ref={fileInputRef}
              type="file"
              accept=".csv,.tsv,.txt,.json"
              onChange={handleFileSelect}
              style={{ display: 'none' }}
            />
            <Upload />
            <p style={{ margin: '10px 0 5px', color: '#2c3e50', fontSize: '14px' }}>
              <strong>Drop your UMAP file here</strong> or click to browse
            </p>
            <p style={{ margin: 0, fontSize: '12px', color: '#8895a5' }}>
              Supports CSV, TSV, and JSON files
            </p>
          </div>
          {status && (
            <div style={{
              marginTop: '10px',
              padding: '12px',
              borderRadius: '4px',
              fontSize: '13px',
              background: status.includes('Error') ? '#f8d7da' : '#d4edda',
              color: status.includes('Error') ? '#721c24' : '#155724',
              border: `1px solid ${status.includes('Error') ? '#f5c6cb' : '#c3e6cb'}`
            }}>
              {status}
            </div>
          )}
        </div>
      );
    };

    // The Main Dashboard Component --------------------------------------------------
    const MLResultsDashboard = () => {
      const [umapData, setUmapData] = useState([]);
      const [selectedPlotType, setSelectedPlotType] = useState('bar');
      const [selectedMetric, setSelectedMetric] = useState('both');
      const [activeTab, setActiveTab] = useState('general');
      const [selectedDataset, setSelectedDataset] = useState('dataset1');

      // Real data from Bai and Haradhvala datasets (averaged)
      const barChartData = [
        { model: 'SVM', accuracy: 0.625, f1Score: 0.59 },
        { model: 'Linear Regression', accuracy: 0.78, f1Score: 0.73 },
        { model: 'MLP', accuracy: 0.80, f1Score: 0.74 },
        { model: 'LDA', accuracy: 0.71, f1Score: 0.62 },
        { model: 'CARai (our method)', accuracy: 0.91, f1Score: 0.93 }
      ];

      // Box plot data - Dataset 1 (Bai)
      const boxPlotDataset1 = {
        'SVM': {
          accuracy: { min: 0.81, q1: 0.85, median: 0.86, q3: 0.87, max: 0.89 },
          f1Score: { min: 0.67, q1: 0.78, median: 0.78, q3: 0.81, max: 0.81 }
        },
        'Linear Regression': {
          accuracy: { min: 0.85, q1: 0.88, median: 0.89, q3: 0.89, max: 0.91 },
          f1Score: { min: 0.74, q1: 0.78, median: 0.80, q3: 0.81, max: 0.85 }
        },
        'MLP': {
          accuracy: { min: 0.85, q1: 0.91, median: 0.91, q3: 0.93, max: 0.94 },
          f1Score: { min: 0.76, q1: 0.78, median: 0.80, q3: 0.83, max: 0.83 }
        },
        'LDA': {
          accuracy: { min: 0.73, q1: 0.73, median: 0.75, q3: 0.75, max: 0.77 },
          f1Score: { min: 0.61, q1: 0.61, median: 0.64, q3: 0.66, max: 0.68 }
        },
        'CARai (our method)': {
          accuracy: { min: 0.92, q1: 0.93, median: 0.95, q3: 0.96, max: 0.97 },
          f1Score: { min: 0.95, q1: 0.95, median: 0.96, q3: 0.96, max: 0.97 }
        }
      };

      // Box plot data - Dataset 2 (Haradhvala)
      const boxPlotDataset2 = {
        'SVM': {
          accuracy: { min: 0.39, q1: 0.42, median: 0.56, q3: 0.59, max: 0.82 },
          f1Score: { min: 0.36, q1: 0.39, median: 0.54, q3: 0.62, max: 0.81 }
        },
        'Linear Regression': {
          accuracy: { min: 0.41, q1: 0.45, median: 0.46, q3: 0.72, max: 0.88 },
          f1Score: { min: 0.36, q1: 0.37, median: 0.43, q3: 0.69, max: 0.87 }
        },
        'MLP': {
          accuracy: { min: 0.40, q1: 0.52, median: 0.55, q3: 0.68, max: 0.80 },
          f1Score: { min: 0.35, q1: 0.44, median: 0.52, q3: 0.70, max: 0.80 }
        },
        'LDA': {
          accuracy: { min: 0.50, q1: 0.52, median: 0.62, q3: 0.73, max: 0.76 },
          f1Score: { min: 0.44, q1: 0.44, median: 0.56, q3: 0.67, max: 0.67 }
        },
        'CARai (our method)': {
          accuracy: { min: 0.83, q1: 0.85, median: 0.87, q3: 0.89, max: 0.92 },
          f1Score: { min: 0.79, q1: 0.81, median: 0.84, q3: 0.88, max: 0.92 }
        }
      };

      const modelColors = {
        'SVM': '#4a90e2',
        'Linear Regression': '#5ba3cf',
        'MLP': '#6bb6dd',
        'LDA': '#3d7bb8',
        'CARai (our method)': '#1e4976'
      };

      const handleDataLoaded = (data) => {
        // Auto-assign colors based on available categorical columns
        const categoryKey = Object.keys(data.categories || {})[0];
        if (categoryKey) {
          const categories = Array.from(new Set(data.map(d => d[categoryKey])));
          const colorScale = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
                             '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'];

          data.forEach(d => {
            const idx = categories.indexOf(d[categoryKey]);
            d.label = d[categoryKey];
            d.color = colorScale[idx % colorScale.length];
          });
        } else {
          // No categories, use single color
          data.forEach(d => {
            d.label = 'Cell';
            d.color = '#1f77b4';
          });
        }

        setUmapData(data);
      };

      const BoxPlotComponent = ({ data, modelColors }) => {
        const models = Object.keys(data);

        return (
          <svg width="1200" height="550" className="mx-auto">
            <g transform="translate(80, 40)">
              {/* Legend - moved to top left */}
              <rect x="10" y="-30" width="14" height="14" fill="#4a90e2" rx="1" />
              <text x="30" y="-20" fontSize="11" fill="#5a6c7d" fontFamily="Inter, sans-serif">Accuracy</text>
              <rect x="100" y="-30" width="14" height="14" fill="#4a90e240" stroke="#4a90e2" strokeWidth="1" rx="1" />
              <text x="120" y="-20" fontSize="11" fill="#5a6c7d" fontFamily="Inter, sans-serif">F1 Score</text>

              {/* Y-axis */}
              <line x1="0" y1="0" x2="0" y2="400" stroke="#a8b8c8" strokeWidth="1.5" />
              <line x1="0" y1="400" x2="1000" y2="400" stroke="#a8b8c8" strokeWidth="1.5" />

              {/* Y-axis labels */}
              {[0, 0.2, 0.4, 0.6, 0.8, 1.0].map((val, idx) => (
                <g key={idx}>
                  <line x1="-5" y1={400 - val * 400} x2="0" y2={400 - val * 400} stroke="#8895a5" />
                  <text x="-10" y={400 - val * 400 + 4} textAnchor="end" fontSize="11" fill="#5a6c7d" fontFamily="Inter, sans-serif">
                    {val.toFixed(1)}
                  </text>
                </g>
              ))}

              {/* Grid lines */}
              {[0, 0.2, 0.4, 0.6, 0.8, 1.0].map((val, idx) => (
                <line key={idx} x1="0" y1={400 - val * 400} x2="1000" y2={400 - val * 400}
                      stroke="#e8eef3" strokeDasharray="3,3" />
              ))}

              {/* Box plots for each model */}
              {models.map((modelName, idx) => {
                const accuracyData = data[modelName].accuracy;
                const f1Data = data[modelName].f1Score;
                const color = modelColors[modelName];
                const colorLight = color + '40';

                const groupWidth = 1000 / models.length;
                const centerX = idx * groupWidth + groupWidth / 2;
                const boxWidth = 28;
                const spacing = 6;

                return (
                  <g key={modelName}>
                    {/* Accuracy Box Plot (left) */}
                    <g transform={`translate(${centerX - spacing - boxWidth / 2}, 0)`}>
                      {/* Whiskers */}
                      <line x1="0" y1={400 - accuracyData.min * 400} x2="0" y2={400 - accuracyData.max * 400}
                            stroke="#666" strokeWidth="1" />
                      {/* Box */}
                      <rect x={-boxWidth / 2} y={400 - accuracyData.q3 * 400} width={boxWidth}
                            height={(accuracyData.q3 - accuracyData.q1) * 400}
                            fill={colorLight} stroke={color} strokeWidth="1.5" rx="3" />
                      {/* Median line */}
                      <line x1={-boxWidth / 2} y1={400 - accuracyData.median * 400}
                            x2={boxWidth / 2} y2={400 - accuracyData.median * 400}
                            stroke="#000000" strokeWidth="1.5" />
                      {/* Min/Max caps */}
                      <line x1={-boxWidth / 3} y1={400 - accuracyData.min * 400}
                            x2={boxWidth / 3} y2={400 - accuracyData.min * 400}
                            stroke="#666" strokeWidth="1" />
                      <line x1={-boxWidth / 3} y1={400 - accuracyData.max * 400}
                            x2={boxWidth / 3} y2={400 - accuracyData.max * 400}
                            stroke="#666" strokeWidth="1" />
                      {/* Median value label - positioned to the left */}
                      <text x={-boxWidth / 2 - 5} y={400 - accuracyData.median * 400 + 4} textAnchor="end" fontSize="10" fill="#2c3e50" fontFamily="Inter, sans-serif" fontWeight="500">
                        {accuracyData.median.toFixed(2)}
                      </text>
                    </g>

                    {/* F1 Score Box Plot (right) */}
                    <g transform={`translate(${centerX + spacing + boxWidth / 2}, 0)`}>
                      {/* Whiskers */}
                      <line x1="0" y1={400 - f1Data.min * 400} x2="0" y2={400 - f1Data.max * 400}
                            stroke="#666" strokeWidth="1" />
                      {/* Box */}
                      <rect x={-boxWidth / 2} y={400 - f1Data.q3 * 400} width={boxWidth}
                            height={(f1Data.q3 - f1Data.q1) * 400}
                            fill={colorLight} stroke={color} strokeWidth="1.5" rx="3" />
                      {/* Median line */}
                      <line x1={-boxWidth / 2} y1={400 - f1Data.median * 400}
                            x2={boxWidth / 2} y2={400 - f1Data.median * 400}
                            stroke="#000000" strokeWidth="1.5" />
                      {/* Min/Max caps */}
                      <line x1={-boxWidth / 3} y1={400 - f1Data.min * 400}
                            x2={boxWidth / 3} y2={400 - f1Data.min * 400}
                            stroke="#666" strokeWidth="1" />
                      <line x1={-boxWidth / 3} y1={400 - f1Data.max * 400}
                            x2={boxWidth / 3} y2={400 - f1Data.max * 400}
                            stroke="#666" strokeWidth="1" />
                      {/* Median value label - positioned to the right */}
                      <text x={boxWidth / 2 + 5} y={400 - f1Data.median * 400 + 4} textAnchor="start" fontSize="10" fill="#2c3e50" fontFamily="Inter, sans-serif" fontWeight="500">
                        {f1Data.median.toFixed(2)}
                      </text>
                    </g>

                    {/* Model label - rotated and centered */}
                    <text
                      x={centerX}
                      y="420"
                      textAnchor="end"
                      fontSize="11"
                      fill={modelName === 'CARai (our method)' ? '#d62728' : '#5a6c7d'}
                      fontFamily="Inter, sans-serif"
                      transform={`rotate(-45, ${centerX}, 420)`}
                    >
                      {modelName}
                    </text>
                  </g>
                );
              })}

              {/* Axis labels */}
              <text x="500" y="490" textAnchor="middle" fontSize="12" fill="#5a6c7d" fontFamily="Inter, sans-serif">Model</text>
              <text x="-40" y="200" textAnchor="middle" fontSize="12" fill="#5a6c7d" fontFamily="Inter, sans-serif" transform="rotate(-90, -40, 200)">
                Score
              </text>
            </g>
          </svg>
        );
      };

      return (
        <div className="min-h-screen" style={{ background: '#f5f7fa' }}>
          {/* Navy header bar */}
          <div style={{
            background: 'linear-gradient(135deg, #1e4976 0%, #2e5f8a 100%)',
            borderBottom: '1px solid #d1dbe6',
            padding: '20px 24px',
            marginBottom: '0'
          }}>
            <div className="max-w-7xl mx-auto">
              <h1 className="text-2xl font-semibold mb-1" style={{ color: '#ffffff', letterSpacing: '-0.02em' }}>
                CARai Dashboard
              </h1>
              <p style={{ color: '#e8f2f7', fontSize: '13px' }}>
                CARai is a pre-trained deep learning framework designed to predict patients' response after CAR-T cell therapy.
              </p>
            </div>
          </div>

          {/* Navigation Tabs */}
          <div style={{ background: '#ffffff', borderBottom: '2px solid #d1dbe6' }}>
            <div className="max-w-7xl mx-auto px-6">
              <div className="flex gap-8">
                <button
                  onClick={() => setActiveTab('general')}
                  className="px-4 py-4 text-sm font-medium transition relative"
                  style={{
                    color: activeTab === 'general' ? '#1e4976' : '#5a6c7d',
                    borderBottom: activeTab === 'general' ? '3px solid #1e4976' : '3px solid transparent',
                    marginBottom: '-2px',
                    fontWeight: activeTab === 'general' ? '600' : '500'
                  }}
                >
                  General
                </button>
                <button
                  onClick={() => setActiveTab('dataset')}
                  className="px-4 py-4 text-sm font-medium transition relative"
                  style={{
                    color: activeTab === 'dataset' ? '#1e4976' : '#5a6c7d',
                    borderBottom: activeTab === 'dataset' ? '3px solid #1e4976' : '3px solid transparent',
                    marginBottom: '-2px',
                    fontWeight: activeTab === 'dataset' ? '600' : '500'
                  }}
                >
                  Training Dataset
                </button>
                <button
                  onClick={() => setActiveTab('model')}
                  className="px-4 py-4 text-sm font-medium transition relative"
                  style={{
                    color: activeTab === 'model' ? '#1e4976' : '#5a6c7d',
                    borderBottom: activeTab === 'model' ? '3px solid #1e4976' : '3px solid transparent',
                    marginBottom: '-2px',
                    fontWeight: activeTab === 'model' ? '600' : '500'
                  }}
                >
                  Model
                </button>
                <button
                  onClick={() => setActiveTab('umap')}
                  className="px-4 py-4 text-sm font-medium transition relative"
                  style={{
                    color: activeTab === 'umap' ? '#1e4976' : '#5a6c7d',
                    borderBottom: activeTab === 'umap' ? '3px solid #1e4976' : '3px solid transparent',
                    marginBottom: '-2px',
                    fontWeight: activeTab === 'umap' ? '600' : '500'
                  }}
                >
                  UMAP Explorer
                </button>
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-6" style={{ paddingTop: '24px' }}>

            {/* General Tab Content */}
            {activeTab === 'general' && (
              <div className="bg-white rounded-sm shadow-sm mb-5" style={{
                border: '1px solid #d1dbe6',
                padding: '32px'
              }}>
                <h2 className="text-xl font-semibold mb-6" style={{ color: '#2c3e50' }}>Motivation</h2>
                <div className="flex gap-8">
                  {/* Left side - Text content */}
                  <div style={{ color: '#5a6c7d', fontSize: '14px', lineHeight: '1.8', flex: '1', minWidth: '0' }}>
                    <p className="mb-4">
                      CAR T-cell therapy has transformed the treatment landscape for patients with B-cell malignancies, yet 30â€“60% of patients fail to respond or relapse (Chong 2021; Schuster 2018). Although numerous studies have explored the biological underpinnings of non-response and relapse, few have focused on building predictive models, especially those that leverage molecular data, to anticipate therapeutic outcomes. Yet, accurate prediction of CAR T-cell response is arguably one of the most clinically valuable goals.
                    </p>
                    <p className="mb-4">
                      In parallel with these clinical challenges, recent advances in large language models for single-cell data, such as Geneformer (Theodoris 2023) and scGPT (Cui 2024), have opened new possibilities for modeling complex cellular states and trajectories. At the same time, large-scale single-cell CAR T datasets have become available (Haradhvala 2022; Bai 2024), providing an unprecedented opportunity to integrate these technologies.
                    </p>
                    <p className="mb-4">
                      Here, we aim to combine these emerging single-cell LLM frameworks with high-resolution CAR T datasets to develop a model capable of predicting patient response to CAR T-cell therapy. Such a model has the potential not only to guide clinical decision-making, but also to uncover new biological determinants of therapeutic success. Moreover, this framework can be extended to predict other clinically relevant CAR T-associated outcomes, including CRS and ICANS.
                    </p>
                  </div>

                  {/* Right side - Figure */}
                  <div style={{ flexShrink: '0', width: '400px' }}>
                    <img src="data/figure2.png" alt="Figure 2" style={{ width: '100%', height: 'auto', borderRadius: '4px' }} />
                  </div>
                </div>
              </div>
            )}

            {/* Dataset Tab Content */}
            {activeTab === 'dataset' && (
              <>
                {/* Datasets Section */}
                <div className="bg-white rounded-sm shadow-sm mb-5" style={{
                  border: '1px solid #d1dbe6',
                  padding: '32px'
                }}>
                  <h2 className="text-xl font-semibold mb-6" style={{ color: '#2c3e50' }}>Datasets</h2>
                  <div style={{ color: '#5a6c7d', fontSize: '14px', lineHeight: '1.8' }}>
                    <p className="mb-4">
                      We used two datasets to train different versions of our model:
                    </p>
                    <p className="mb-4">
                      The <strong>Haradhvala 2022 dataset</strong> includes scRNA-seq profiles of PBMCs from 32 individuals with LBCL treated with either axi-cel (n=19) or tisa-cel (n=13), two distinct CAR T-cell products. Fifteen patients were classified as non-responders or experienced relapse within six months based on PET imaging. For our analysis, we trained the model using the infusion product (IP) samples from this cohort.
                    </p>
                    <p>
                      The <strong>Bai 2024 dataset</strong> consists of scRNA-seq data from infusion products collected from 82 pediatric patients with B-ALL treated with CTL019. Among these patients, 25 achieved a complete response and 6 were non-responsive. We trained our model using the unstimulated infusion product samples from these 31 patients.
                    </p>
                  </div>
                </div>

                {/* UMAP Visualization Section */}
                <div className="bg-white rounded-sm shadow-sm mb-5" style={{
                  border: '1px solid #d1dbe6',
                  padding: '20px'
                }}>
                  <h2 className="text-lg font-semibold mb-4" style={{ color: '#2c3e50' }}>UMAP Visualization</h2>

                  {/* UMAP Image */}
                  <div className="flex justify-center">
                    <img src="data/umap.png" alt="UMAP Visualization" style={{ maxWidth: '100%', height: 'auto', borderRadius: '4px' }} />
                  </div>
                </div>
              </>
            )}

            {/* UMAP Explorer Tab Content */}
            {activeTab === 'umap' && (
              <div className="bg-white rounded-sm shadow-sm mb-5" style={{
                border: '1px solid #d1dbe6',
                padding: '20px',
                minHeight: '800px'
              }}>
                <h2 className="text-lg font-semibold mb-4" style={{ color: '#2c3e50' }}>Interactive UMAP Viewer</h2>
                <p style={{ color: '#5a6c7d', fontSize: '14px', marginBottom: '16px' }}>
                  Explore the UMAP visualization with interactive controls. Upload your own data or use the default dataset.
                </p>
                <iframe 
                  src="http://localhost:5173/" 
                  style={{
                    width: '100%',
                    height: '750px',
                    border: 'none',
                    borderRadius: '4px',
                    background: 'white'
                  }}
                  title="UMAP Viewer"
                />
              </div>
            )}

            {/* Model Tab Content */}
            {activeTab === 'model' && (
              <>
                {/* Run Model Panel */}
                <div className="bg-white rounded-sm shadow-sm mb-5" style={{
                  border: '1px solid #d1dbe6',
                  padding: '20px'
                }}>
                  <h2 className="text-lg font-semibold mb-4" style={{ color: '#2c3e50' }}>Predict Response</h2>
                  <RunModelPanel />
                </div>

                {/* Model Workflow Panel */}
                <div className="bg-white rounded-sm shadow-sm mb-5" style={{
                  border: '1px solid #d1dbe6',
                  padding: '20px'
                }}>
                  <h2 className="text-lg font-semibold mb-4" style={{ color: '#2c3e50' }}>Model Workflow</h2>

                  {/* Model Description Image */}
                  <div className="flex justify-center mb-6">
                    <img src="data/figure.png" alt="Model Description" style={{ maxWidth: '100%', height: 'auto' }} />
                  </div>
                </div>

                {/* Metrics Panel */}
                <div className="bg-white rounded-sm shadow-sm" style={{
                  border: '1px solid #d1dbe6',
                  padding: '20px'
                }}>
                  <div className="flex justify-between items-center mb-5">
                    <h2 className="text-lg font-semibold" style={{ color: '#2c3e50' }}>Model Performance Metrics</h2>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setSelectedPlotType('bar')}
                        className="flex items-center gap-2 px-3 py-1.5 rounded-sm transition text-sm"
                        style={{
                          background: selectedPlotType === 'bar' ? '#4a90e2' : '#e8f2f7',
                          color: selectedPlotType === 'bar' ? '#ffffff' : '#5a6c7d',
                          fontSize: '13px',
                          fontWeight: '500',
                          border: selectedPlotType === 'bar' ? 'none' : '1px solid #d1dbe6'
                        }}
                      >
                        <BarChart3 />
                        Bar Chart
                      </button>
                      <button
                        onClick={() => setSelectedPlotType('box')}
                        className="flex items-center gap-2 px-3 py-1.5 rounded-sm transition text-sm"
                        style={{
                          background: selectedPlotType === 'box' ? '#4a90e2' : '#e8f2f7',
                          color: selectedPlotType === 'box' ? '#ffffff' : '#5a6c7d',
                          fontSize: '13px',
                          fontWeight: '500',
                          border: selectedPlotType === 'box' ? 'none' : '1px solid #d1dbe6'
                        }}
                      >
                        <BoxIcon />
                        Box Plot
                      </button>
                    </div>
                  </div>

                  {selectedPlotType === 'bar' ? (
                    <div>
                      <h3 className="text-sm font-medium mb-4 text-center" style={{ color: '#5a6c7d' }}>
                        Cross-Patient Testing Results
                      </h3>
                      <BarChartComponent data={barChartData} modelColors={modelColors} />
                    </div>
                  ) : (
                    <div>
                      <h3 className="text-sm font-medium mb-4 text-center" style={{ color: '#5a6c7d' }}>
                        Cross-Validation for {selectedDataset === 'dataset1' ? 'Dataset 1' : 'Dataset 2'}
                      </h3>

                      {/* Dataset Tabs */}
                      <div className="flex gap-2 mb-5 justify-center">
                        <button
                          onClick={() => setSelectedDataset('dataset1')}
                          className="px-4 py-2 rounded-sm text-sm"
                          style={{
                            background: selectedDataset === 'dataset1' ? '#4a90e2' : '#e8f2f7',
                            color: selectedDataset === 'dataset1' ? '#ffffff' : '#5a6c7d',
                            fontSize: '13px',
                            fontWeight: '500',
                            border: selectedDataset === 'dataset1' ? 'none' : '1px solid #d1dbe6'
                          }}
                        >
                          Dataset 1 (Bai)
                        </button>
                        <button
                          onClick={() => setSelectedDataset('dataset2')}
                          className="px-4 py-2 rounded-sm text-sm"
                          style={{
                            background: selectedDataset === 'dataset2' ? '#4a90e2' : '#e8f2f7',
                            color: selectedDataset === 'dataset2' ? '#ffffff' : '#5a6c7d',
                            fontSize: '13px',
                            fontWeight: '500',
                            border: selectedDataset === 'dataset2' ? 'none' : '1px solid #d1dbe6'
                          }}
                        >
                          Dataset 2 (Haradhvala)
                        </button>
                      </div>

                      <BoxPlotComponent
                        data={selectedDataset === 'dataset1' ? boxPlotDataset1 : boxPlotDataset2}
                        modelColors={modelColors}
                      />
                    </div>
                  )}
                </div>
              </>
            )}

          </div>
        </div>
      );
    };

    // Render the app to the DOM
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<MLResultsDashboard />);
  </script>
</body>
</html>
